{% extends 'base.html' %}

{% block content %}

<div class="page-header">
    <h1>üìù Nuovo Riepilogo Ordini</h1>
    <button class="btn-home" 
        data-url="{{ url_for('home') }}" 
        onclick="window.location.href=this.dataset.url">
        Home
    </button>
</div>

<div class="card card-blue-border">
    <div class="form-row">
        <div class="form-group flex-1">
            <label for="data_consegna">Data di Consegna</label>
            <input type="date" id="data_consegna" required>
        </div>
        <div class="form-group flex-3">
            <label for="note_generali">Note Aggiuntive (Opzionale)</label>
            <input type="text" id="note_generali" placeholder="Vuoto...">
        </div>
    </div>
</div>

<div class="card card-dashed">
    <h2 class="card-title">Aggiungi riga all'ordine</h2>
    
    <div class="form-row flex-end-align">
        
        <div class="form-group flex-2 min-200">
            <a id="btn-link-analisi" href="#">
                üìä Vedi Storico
            </a>
            <label for="select_cliente">Cliente</label>
            <select id="select_cliente" class="select2-box">
                <option value=""></option>
                {% for c in clienti %}
                <option value="{{ c.id }}" data-tipo="clienti">{{ c.nome }} (Cod. {{ c.codice }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group flex-2 min-200">
            <label for="select_prodotto">Prodotto</label>
            <select id="select_prodotto" class="select2-box">
                <option value=""></option>
                {% for p in prodotti %}
                <option value="{{ p.id }}" data-tipo="prodotti">{{ p.nome }} (Cod. {{ p.codice }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group flex-0 min-100">
            <label for="quantita">Cartoni</label>
            <input type="number" id="quantita" min="1" step="1" value="1" class="text-center">
        </div>

        <div class="form-group">
            <button type="button" onclick="aggiungiRiga()" class="btn-add-row" id="btn_add_row">
                ‚¨áÔ∏è Aggiungi
            </button>
        </div>

    </div>
</div>

<div class="card">
    <h2>Riepilogo da Inviare</h2>
    
    <table id="tabella_ordine" class="data-table display width-100">
        <thead>
            <tr>
                <th style="width: 20%;">Cliente</th>
                <th style="width: 50%;">Prodotto</th>
                <th style="width: 15%;">Q.t√†</th>
                <th style="width: 15%;">Azioni</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="totali-box">
        <div class="totale-item">
            Totale Clienti: <span id="tot-clienti" class="totale-numero">0</span>
        </div>
        <div class="totale-item">
            Totale Cartoni: <span id="tot-cartoni" class="totale-numero">0</span>
        </div>
    </div>

    <div class="footer-buttons">
        
        <button id="btn_conferma" onclick="salvaTutto()" class="btn-confirm" disabled>
            ‚úÖ Conferma e Crea Preview
        </button>

        <button onclick="svuotaTutto()" class="btn-clear">
            üóëÔ∏è CANCELLA TUTTO
        </button>
    
    </div>
</div>

<div id="modal-prodotto" class="modal-overlay" style="display:none;">
    <div class="card modal-content">
        <h2>‚ú® Aggiungi Prodotto Veloce</h2>
        <form id="form-add-prod" action="{{ url_for('aggiungi_prodotto') }}" method="POST">
            <input type="hidden" name="next" value="crea_ordine">
            
            <div class="form-group">
                <label for="codice_prodotto_modal">Codice</label>
                <input type="number" id="codice_prodotto_modal" name="codice" min="1" step="1" required placeholder="Es. 100">
            </div>
            
            <div class="form-group">
                <label for="nome_prodotto_modal">Nome</label>
                <input type="text" id="nome_prodotto_modal" name="nome" required>
            </div>
            
            <div class="form-group">
                <label for="ingredienti_prodotto_modal">Ingredienti</label>
                <input type="text" id="ingredienti_prodotto_modal" name="ingredienti">
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="chiudiModalProdotto()" class="btn-cancel">Annulla</button>
                <button type="submit" class="btn-save">Salva</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-cliente" class="modal-overlay" style="display:none;">
    <div class="card modal-content">
        <h2>‚ú® Aggiungi Cliente Veloce</h2>
        <form id="form-add-cli" action="{{ url_for('aggiungi_cliente') }}" method="POST">
            <input type="hidden" name="next" value="crea_ordine">
            
            <div class="form-group">
                <label for="codice_cliente_modal">Codice</label>
                <input type="number" id="codice_cliente_modal" name="codice" min="1" step="1" required placeholder="Es. 1500">
            </div>
            
            <div class="form-group">
                <label for="nome_cliente_modal">Nome</label>
                <input type="text" id="nome_cliente_modal" name="nome" required>
            </div>
            
            <div class="form-group">
                <label for="note_cliente_modal">Note</label>
                <input type="text" id="note_cliente_modal" name="note">
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="chiudiModalCliente()" class="btn-cancel">Annulla</button>
                <button type="submit" class="btn-save">Salva</button>
            </div>
        </form>
    </div>
</div>

<script>
    var tabella; 

    // --- 1. FUNZIONE FORMATTAZIONE ---
    function formatOption(state) {
        if (!state.id) return state.text;
        
        var element = $(state.element);
        var tipo = element.attr('data-tipo'); 
        
        // --- 1. LOGICA STELLA (Visualizzazione) ---
        // Recuperiamo lo score dall'attributo HTML data-score
        var score = element.attr('data-score');
        var htmlTesto = state.text;

        // Se c'√® uno score, arricchiamo il testo visualizzato
        if (score && parseInt(score) > 0) {
            htmlTesto = '<span style="color:#f1c40f;">‚≠ê</span> ' + state.text + ' <span style="font-size:1em; color:#2c2e2f; font-weight:normal;">(' + score + ')</span>';
        }

        // Se non c'√® il "tipo" (es. opzioni di sistema), restituiamo solo il testo formattato
        if (!tipo) return $('<span>' + htmlTesto + '</span>');

        // --- 2. LOGICA MATITA (Modifica) ---
        var urlModifica = "/" + tipo + "/modifica/" + state.id + "?next=crea_ordine";
        
        // --- 3. COSTRUZIONE HTML FINALE ---
        var $state = $(
            '<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">' +
                // Qui mettiamo htmlTesto che contiene eventualmente la stella
                '<span>' + htmlTesto + '</span>' +
                
                '<span onmousedown="event.preventDefault(); event.stopPropagation();"' +
                      ' onmouseup="event.preventDefault(); event.stopPropagation(); window.location.href=\'' + urlModifica + '\';"' +
                      ' class="btn-edit-select"' +
                      ' style="cursor: pointer; color: #f39c12; font-weight: bold; font-size: 1.3rem; padding-left: 15px; z-index: 9999;">' +
                      '‚úèÔ∏è' +
                '</span>' +
            '</div>'
        );
        return $state;
    }

    // --- FUNZIONE TOTALI ---
    function aggiornaTotaliVisivi() {
        if (!tabella) return;
        var totaleCartoni = 0;
        var clientiUnici = new Set();
        tabella.rows().data().each(function (value) {
            let qta = parseInt($(value[2]).find('.qty-val').text());
            if (!isNaN(qta)) totaleCartoni += qta;
            let idCliente = $(value[0]).data('id');
            if (idCliente) clientiUnici.add(idCliente);
        });
        $('#tot-clienti').text(clientiUnici.size);
        $('#tot-cartoni').text(totaleCartoni);
    }

    $(document).ready(function() {
        // Funzione Helper per aggiungere il tasto "Aggiungi Nuovo"
        function setupAddButton(selectId, btnClass, text, modalId, formId) {
            $(selectId).off('select2:open');
            $(selectId).on('select2:open', function() {
                $('.custom-add-btn').remove();
                var a = $('<a class="custom-add-btn ' + btnClass + '" style="display:block; padding:10px; background:#e8f8f5; color:#27ae60; font-weight:bold; cursor:pointer; border-bottom:1px solid #ddd;">‚ûï ' + text + '</a>');
                a.on('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $(selectId).select2('close');
                    $(formId)[0].reset();
                    $(formId).find('.error-highlight').removeClass('error-highlight');
                    if (text.includes("CLIENTE")) {
                        apriModalCliente();   // <--- Chiama la funzione che blocca lo scroll
                    } else if (text.includes("PRODOTTO")) {
                        apriModalProdotto();  // <--- Chiama la funzione che blocca lo scroll
                    }
                });

                var resultsId = "select2-" + $(selectId).attr('id') + "-results";
                $('#' + resultsId).parent().prepend(a);
            });
        }

        // Configurazione SELECT2
        $('#select_cliente').select2({
            placeholder: "Cerca Cliente...", allowClear: true, width: '100%',
            templateResult: formatOption, escapeMarkup: function(m) { return m; },
            language: { noResults: function() { return "Nessun risultato trovato"; }, searching: function() { return "Sto cercando..."; } }
        });
        setupAddButton('#select_cliente', 'btn-add-cli-custom', 'AGGIUNGI NUOVO CLIENTE', '#modal-cliente', '#form-add-cli');

        $('#select_prodotto').select2({
            placeholder: "Cerca Prodotto...", allowClear: true, width: '100%',
            templateResult: formatOption, escapeMarkup: function(m) { return m; },
            language: { noResults: function() { return "Nessun risultato trovato"; }, searching: function() { return "Sto cercando..."; } }
        });
        setupAddButton('#select_prodotto', 'btn-add-prod-custom', 'AGGIUNGI NUOVO PRODOTTO', '#modal-prodotto', '#form-add-prod');

        // ASCOLTATORE CAMBIO CLIENTE (Il cuore del suggeritore)
        // Memorizziamo l'elenco originale delle opzioni prodotti all'avvio della pagina
        // Questo serve per poter "resettare" l'ordine alfabetico quando cambiamo cliente
        var $selectProd = $('#select_prodotto');
        var opzioniOriginali = $selectProd.find('option').clone();

        // ASCOLTATORE CAMBIO CLIENTE
        $('#select_cliente').on('change', function (e) {
            var clienteId = $(this).val();
            var clienteNome = "";
            if (clienteId) {
                clienteNome = $(this).find('option:selected').text().split(' (Cod.')[0];
            }

            // Reset o Aggiornamento Link se non c'√® cliente selezionato
            if (!clienteId) {
                $('#btn-link-analisi').hide();
                
                // Reset prodotti (codice vecchio)
                $selectProd.empty().append(opzioniOriginali.clone());
                $selectProd.val(null).trigger('change.select2');
                return;
            }

            // --- LINK ANALISI ---
            $('#btn-link-analisi')
                .text("üìä Vedi storico di '" + clienteNome +"'")
                .attr('href', "/storico?cliente_id=" + clienteId + "&from=crea_ordine") 
                .show();

            // --- RICARICA SUGGERIMENTI PRODOTTI ---
            fetch('/api/suggerimenti_cliente/' + clienteId)
            .then(r => r.json())
            .then(suggerimenti => {
                var nuoveOpzioni = opzioniOriginali.clone();
                
                nuoveOpzioni.each(function() {
                    var id = $(this).val();
                    if (id && suggerimenti[id]) {
                        var qta = suggerimenti[id];
                        
                        // Impostiamo l'attributo data-score HTML
                        $(this).attr('data-score', qta);
                        
                        // NON TOCCHIAMO IL TESTO!
                        
                    } else {
                        $(this).attr('data-score', 0);
                    }
                });

                // Ordina le opzioni in base allo score
                nuoveOpzioni.sort(function(a, b) {
                    var scoreA = parseInt($(a).attr('data-score')) || 0;
                    var scoreB = parseInt($(b).attr('data-score')) || 0;
                    
                    if (scoreA > 0 || scoreB > 0) {
                        return scoreB - scoreA; // Decrescente
                    }
                    return $(a).text().localeCompare($(b).text()); // Alfabetico
                });

                // INSERIMENTO E REFRESH
                $selectProd.empty().append(nuoveOpzioni);
                $selectProd.val(null).trigger('change.select2'); 
            });
        });
        
        // Se deseleziona cliente, pulisci
        $('#select_cliente').on('select2:clear', function() {
            $('#btn-link-analisi').hide();
            // Resetta nomi prodotti (togli stelle)
            var selectProd = $('#select_prodotto');
            selectProd.find('option').each(function() {
                var text = $(this).text().replace(/^‚≠ê\s+/, '').replace(/\s+\(\d+\)$/, '');
                $(this).text(text);
            });
            // Riordina alfabeticamente base (opzionale, o lascia cos√¨)
            selectProd.trigger('change');
        });

        // DATATABLES
        if ($('#tabella_ordine').length) {
            tabella = $('#tabella_ordine').DataTable({
                "paging": false, "searching": false, "info": false, "ordering": true,
                "order": [[0, 'asc']], 
                "language": { "emptyTable": "Nessun prodotto inserito. Aggiungine uno sopra!üëÜ" },
                "columnDefs": [ { "orderable": false, "targets": 3 }, { "orderable": false, "targets": 2 } ]
            });
        }

        caricaBozza();
        $('#data_consegna, #note_generali').on('change input', function() { salvaBozza(); });

        // MODALE ERRORE
        const urlParams = new URLSearchParams(window.location.search);
        const modalToOpen = urlParams.get('open_modal');
        if (modalToOpen === 'cliente') {
            apriModalCliente();
            mostraErroreCampo('#form-add-cli input[name="codice"]');
        } else if (modalToOpen === 'prodotto') {
            apriModalProdotto();
            mostraErroreCampo('#form-add-prod input[name="codice"]');
        }

        // --- LOGICA RITORNO DA MODIFICA (Evidenzia nella TABELLA, non nel menu) ---
        const updatedProdCode = urlParams.get('updated_product');
        const updatedClientCode = urlParams.get('updated_client');

        if (updatedProdCode || updatedClientCode) {
            tabella.rows().every(function(rowIdx, tableLoop, rowLoop) {
                var data = this.data(); 
                var nodoRiga = this.node(); 
                var trovato = false;

                // Caso 1: Modifica PRODOTTO
                // AGGIUNTO + ')' per cercare la fine esatta del codice
                if (updatedProdCode && data[1].includes('Cod. ' + updatedProdCode + ')')) {
                    trovato = true;
                }

                // Caso 2: Modifica CLIENTE
                // AGGIUNTO + ')' qui
                if (updatedClientCode && data[0].includes('Cod. ' + updatedClientCode + ')')) {
                    trovato = true;
                }

                if (trovato) {
                    nodoRiga.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    $(nodoRiga).addClass('highlight-new-row');
                    setTimeout(function() {
                        $(nodoRiga).removeClass('highlight-new-row');
                    }, 4000);
                }
            });
            
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- FIX WARNING SELECT2 (ID/Name mancanti nella ricerca) ---
        function fixSelect2Search(selectId, nameSuffix) {
            $(selectId).on('select2:open', function() {
                // Cerchiamo l'input di ricerca che √® appena apparso nel DOM
                // Usiamo setTimeout 0 per assicurarci che il rendering sia finito
                setTimeout(function() {
                    // Selezioniamo il campo di ricerca dentro il container Select2 APERTO
                    var searchInput = document.querySelector('.select2-container--open .select2-search__field');
                    
                    if (searchInput) {
                        // Assegniamo ID e Name univoci
                        searchInput.setAttribute('id', 's2_search_' + nameSuffix);
                        searchInput.setAttribute('name', 's2_search_' + nameSuffix);
                        // Gi√† che ci siamo, sistemiamo l'etichetta per l'accessibilit√†
                        searchInput.setAttribute('aria-label', 'Cerca ' + nameSuffix);
                    }
                }, 1);
            });
        }

    // Applichiamo il fix alle due select
    fixSelect2Search('#select_cliente', 'cliente');
    fixSelect2Search('#select_prodotto', 'prodotto');

    });

    // --- ALTRE FUNZIONI ---
    function mostraErroreCampo(idCampo) {
        let campo = $(idCampo);
        campo.addClass('error-highlight');
        if (campo.hasClass('select2-box')) { campo.next('.select2-container').find('.select2-selection').css({'border': '2px solid #e74c3c', 'background-color': '#fce4e4'}); }
        campo.one('focus input change select2:open', function() {
            $(this).removeClass('error-highlight');
            if ($(this).hasClass('select2-box')) { $(this).next('.select2-container').find('.select2-selection').css({'border': '', 'background-color': ''}); }
        });
    }

    function aggiornaStatoBottone() {
        if(!tabella) return;
        var numeroRighe = tabella.rows().count();
        var btn = $('#btn_conferma');
        if (numeroRighe > 0) { btn.prop('disabled', false).css({'opacity': '1', 'cursor': 'pointer'}); } 
        else { btn.prop('disabled', true).css({'opacity': '0.5', 'cursor': 'not-allowed'}); }
    }

    function generaHtmlQta(qta) {
        let disabled = (qta <= 1) ? 'disabled' : '';
        return `<div class="qty-control"><span class="qty-val">${qta}</span><div class="qty-buttons"><button onclick="cambiaQta(this, -1)" class="btn-qty btn-minus" ${disabled}>-</button><button onclick="cambiaQta(this, 1)" class="btn-qty btn-plus">+</button></div></div>`;
    }

    function cambiaQta(btn, delta) {
        var rigaTr = $(btn).closest('tr');
        var rigaDt = tabella.row(rigaTr);
        var datiRiga = rigaDt.data();
        var htmlQta = datiRiga[2];
        var qtaAttuale = parseInt($(htmlQta).find('.qty-val').text());
        var nuovaQta = qtaAttuale + delta;
        if (nuovaQta < 1) return;
        datiRiga[2] = generaHtmlQta(nuovaQta);
        rigaDt.data(datiRiga).draw(false); 
        salvaBozza();
    }

    function salvaBozza() {
        var bozza = { data: $('#data_consegna').val(), note: $('#note_generali').val(), righe: [] };
        tabella.rows().data().each(function (value) {
            let c_id = $(value[0]).data('id'); let c_text = $(value[0]).text();
            let p_id = $(value[1]).data('id'); let p_text = $(value[1]).text();
            let qta = parseInt($(value[2]).find('.qty-val').text());
            bozza.righe.push({ cliente_id: c_id, cliente_check: c_text, prodotto_id: p_id, prodotto_check: p_text, quantita: qta });
        });
        localStorage.setItem('bozza_ordine_papa', JSON.stringify(bozza));
        aggiornaStatoBottone();
        aggiornaTotaliVisivi();
    }

    function caricaBozza() {
        var bozzaSalvata = localStorage.getItem('bozza_ordine_papa');
        if (!bozzaSalvata) { aggiornaStatoBottone(); return; }
        var bozza = JSON.parse(bozzaSalvata);
        if(bozza.data) $('#data_consegna').val(bozza.data);
        if(bozza.note) $('#note_generali').val(bozza.note);
        if (bozza.righe && bozza.righe.length > 0) {
            tabella.clear();
            var bozzaSporca = false; 
            bozza.righe.forEach(function(riga) {
                let opzC = $('#select_cliente option[value="' + riga.cliente_id + '"]');
                let opzP = $('#select_prodotto option[value="' + riga.prodotto_id + '"]');
                if (opzC.length > 0 && opzP.length > 0) {
                    let btnElimina = '<button onclick="rimuoviRiga(this)" class="btn-rimuoviRiga">üóëÔ∏è Elimina</button>';
                    let cellaQta = generaHtmlQta(riga.quantita);
                    tabella.row.add([
                        '<span data-id="' + riga.cliente_id + '">' + opzC.text() + '</span>',
                        '<span data-id="' + riga.prodotto_id + '">' + opzP.text() + '</span>',
                        cellaQta,
                        btnElimina
                    ]);
                } else { bozzaSporca = true; }
            });
            tabella.draw();
            if (bozzaSporca) salvaBozza();
        }
        aggiornaStatoBottone();
        aggiornaTotaliVisivi();
    }

    function cancellaMemoriaBozza() { 
        localStorage.removeItem('bozza_ordine_papa');
    }

    function aggiungiRiga() {
        let cId = $('#select_cliente').val();
        let pId = $('#select_prodotto').val();
        let qta = parseInt($('#quantita').val());
        let errore = false;

        if (!cId) { mostraErroreCampo('#select_cliente'); errore = true; }
        if (!pId) { mostraErroreCampo('#select_prodotto'); errore = true; }
        if (!qta || qta < 1) { mostraErroreCampo('#quantita'); errore = true; }
        if (errore) return;

        let cText = $('#select_cliente option:selected').text();
        let pText = $('#select_prodotto option:selected').text();

        var duplicato = false;
        tabella.rows().every(function () {
            var d = this.data();
            var rowNode = this.node(); // Questo √® l'elemento <tr>
            
            let currCId = $(d[0]).data('id');
            let currPId = $(d[1]).data('id');

            if (String(currCId) === String(cId) && String(currPId) === String(pId)) { 
                duplicato = true; 
                
                // EVIDENZIAMO LA RIGA
                $(rowNode).addClass('flash-error');

                // 2. SCROLLIAMO FINO ALLA RIGA
                // 'center' mette la riga esattamente al centro dello schermo
                rowNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Rimuoviamo l'evidenziazione dopo 3 secondi
                setTimeout(function() {
                    $(rowNode).removeClass('flash-error');
                }, 3000);

                return false; // Interrompe il ciclo (abbiamo trovato il duplicato)
            }
        });

        if (duplicato) {
            Swal.fire({
                icon: 'warning',
                title: 'Attenzione!',
                text: '‚ö†Ô∏è Riga gi√† presente!',
                returnFocus: false
            });
            $('#quantita').val(1);
            $('#select_prodotto').val(null).trigger('change');
            return;
        }

        let btnElimina = '<button onclick="rimuoviRiga(this)" class="btn-rimuoviRiga">üóëÔ∏è Elimina</button>';
        let cellaQta = generaHtmlQta(qta);

        var nuovaRiga = tabella.row.add([
            '<span data-id="' + cId + '">' + cText + '</span>',
            '<span data-id="' + pId + '">' + pText + '</span>',
            cellaQta,
            btnElimina
        ]);
        //highlight nuova riga
        var nodoRiga = nuovaRiga.node();
        $(nodoRiga).addClass('highlight-new-row');
        nuovaRiga.draw(false);
        setTimeout(function() { $(nodoRiga).removeClass('highlight-new-row'); }, 4000);
        if(nodoRiga) { nodoRiga.scrollIntoView({ behavior: 'smooth', block: 'center' }); }

        $('#quantita').val(1);
        $('#select_prodotto').val(null).trigger('change');
        salvaBozza();

        //var btnConferma = document.getElementById('btn_conferma');
        //if (btnConferma) { btnConferma.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
    }

    function rimuoviRiga(bottone) {
        Swal.fire({
            title: 'Rimuovere prodotto?', text: "Vuoi cancellare questa riga?", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'S√¨, rimuovi', cancelButtonText: 'Annulla'
        }).then((result) => {
            if (result.isConfirmed) {
                var riga = $(bottone).closest('tr');
                tabella.row(riga).remove().draw();
                salvaBozza();
                Swal.fire({ icon: 'success', title: 'Riga Rimossa', showConfirmButton: false, timer: 2000, width: '200px' });
            }
        });
    }

    function svuotaTutto() {
        Swal.fire({
            title: 'Svuotare tutto?', text: "Perderai tutti i dati inseriti finora.", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√¨, svuota!', cancelButtonText: 'No'
        }).then((result) => {
            if (result.isConfirmed) {
                tabella.clear().draw(); 
                cancellaMemoriaBozza();
                $('#select_cliente').val(null).trigger('change'); $('#select_prodotto').val(null).trigger('change');
                $('#quantita').val(1); $('#data_consegna').val(''); $('#note_generali').val('');
                $('#tot-clienti').text('0'); $('#tot-cartoni').text('0');
                aggiornaStatoBottone();
                $('.alert').fadeOut(); 
                $('.error-highlight').removeClass('error-highlight');
                $('.select2-selection').css({'border': '', 'background-color': ''});
                Swal.fire('Fatto!', 'La pagina √® stata svuotata interamente!', 'success');
            }
        });
    }

    function salvaTutto() {
        $('.error-highlight').removeClass('error-highlight');
        $('.select2-selection').css({'border': '', 'background-color': ''});

        var dataConsegna = $('#data_consegna').val();
        if (!dataConsegna) { 
            Swal.fire({ icon: 'warning', title: 'Attenzione!', text: '‚ö†Ô∏è Inserisci la Data di consegna!' }); 
            mostraErroreCampo('#data_consegna'); return; 
        }
        if (tabella.rows().count() === 0) { 
            Swal.fire({ icon: 'error', title: 'Errore!', text: '‚ö†Ô∏è Ordine vuoto!' }); return; 
        }

        var note = $('#note_generali').val();
        var msgHtml = "Sei sicuro di voler generare l'anteprima PDF?";
        if (!note || note.trim() === "") { 
            msgHtml = "‚ö†Ô∏è <b>Non ci sono note aggiuntive.</b><br><br>Sei sicuro di voler procedere?"; 
        }

        Swal.fire({
            title: 'Conferma Ordine', html: msgHtml, icon: 'question',
            showCancelButton: true, confirmButtonColor: '#27ae60', confirmButtonText: 'S√¨, procedi', cancelButtonText: 'Controlla ancora'
        }).then((result) => {
            if (result.isConfirmed) {
                var datiDaInviare = { data: dataConsegna, note: note, righe: [] };
                tabella.rows().data().each(function (value) {
                    let c_id = $(value[0]).data('id'); let c_text = $(value[0]).text();
                    let p_id = $(value[1]).data('id'); let p_text = $(value[1]).text();
                    let qta = parseInt($(value[2]).find('.qty-val').text());
                    datiDaInviare.righe.push({ cliente_id: c_id, cliente_check: c_text, prodotto_id: p_id, prodotto_check: p_text, quantita: qta });
                });

                var btn = $('#btn_conferma');
                btn.text('‚è≥ Generazione PDF in corso...').prop('disabled', true);

                fetch('/genera_anteprima', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(datiDaInviare)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "OK") {
                        window.location.href = "/mostra_preview?file=" + encodeURIComponent(data.filename);
                    } else {
                        Swal.fire({ icon: 'error', title: 'Errore nel server!', text: '‚ö†Ô∏è Errore: '+data });
                        btn.text('‚úÖ Conferma e Crea Ordine').prop('disabled', false);
                    }
                })
                .catch(error => {
                    Swal.fire({ icon: 'error', title: 'Errore!', text: '‚ö†Ô∏è Errore di connessione o generazione PDF!' });
                    btn.text('‚úÖ Conferma e Crea Ordine').prop('disabled', false);
                });
            }
        });
    }

    function apriModalCliente() {
        // Blocca scroll
        $('body').addClass('no-scroll');
        $('#modal-cliente').show();
    }
    
    function chiudiModalCliente() {
        $('#modal-cliente').hide();
        // Sblocca scroll
        $('body').removeClass('no-scroll');
        
        /* Pulisce i campi (opzionale, ma consigliato)
        $('#codice_cliente_modal').val('');
        $('#nome_cliente_modal').val('');
        $('#note_cliente_modal').val('');*/
    }

    function apriModalProdotto() {
        // Blocca scroll
        $('body').addClass('no-scroll');
        $('#modal-prodotto').show();
    }
    
    function chiudiModalProdotto() {
        $('#modal-prodotto').hide();
        // Sblocca scroll
        $('body').removeClass('no-scroll');
    
        /* Pulisce i campi (opzionale, ma consigliato)
        $('#codice_prodotto_modal').val('');
        $('#nome_prodotto_modal').val('');
        $('#ingredienti_prodotto_modal').val('');*/
    }

</script>

{% endblock %}