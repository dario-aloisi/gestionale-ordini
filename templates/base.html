<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Gestionale Ordini</title>
        
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://npmcdn.com/flatpickr/dist/l10n/it.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    </head>
<body>

    <header>
        <h1>Gestionale Ordini</h1>
    </header>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              
    
              {% if category == 'error' %}
              <script>
                // Aspetta che la pagina sia caricata
                document.addEventListener("DOMContentLoaded", function() {
                    // Cerca tutti gli input che si chiamano 'codice' e li colora di rosso
                    var campiCodice = document.querySelectorAll('input[name="codice"]');
                    campiCodice.forEach(function(el) {
                        el.classList.add('error-highlight');
                        
                        // Rimuovi al click
                        el.addEventListener('focus', function() {
                            this.classList.remove('error-highlight');
                        }, {once: true});
                    });
    
                    // Se siamo in un modale (crea_ordine), dobbiamo assicurarci che si riapra o che l'errore sia visibile
                    // Ma visto che il redirect ricarica la pagina, il modale si chiude. 
                    // Per ora l'alert in alto Ã¨ sufficiente per avvisare.
                });
              </script>
              {% endif %}
    
            {% endfor %}
          {% endif %}
        {% endwith %}
        
    </div>

    <div class="container main-content">
        {% block content %}{% endblock %}
    </div>

    <div id="flash-data" data-messages='{{ get_flashed_messages(with_categories=true) | tojson | safe }}'></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var dataDiv = document.getElementById('flash-data');
            if (dataDiv) {
                var rawData = dataDiv.getAttribute('data-messages');
                try {
                    var messaggi = JSON.parse(rawData);
                    if (messaggi && messaggi.length > 0) {
                        messaggi.forEach(function(item) {
                            var tipo = item[0];
                            var testo = item[1];
                            var icona = (tipo === 'error') ? 'error' : 'success';

                            if (icona === 'success') {
                                // Toast Verde (Successo)
                                Swal.fire({
                                    icon: 'success',
                                    title: testo,
                                    toast: true,
                                    //position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true
                                });
                            } else {
                                // Popup Rosso (Errore)
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Attenzione',
                                    text: testo,
                                    confirmButtonColor: '#3085d6'
                                });
                                // Evidenzia errori
                                document.querySelectorAll('input[name="codice"]').forEach(el => {
                                    el.classList.add('error-highlight');
                                    el.addEventListener('focus', function() { this.classList.remove('error-highlight'); }, {once: true});
                                });
                            }
                        });
                    }
                } catch (e) { console.error("Errore messaggi:", e); }
            }
        });
    </script>

</body>

</html>